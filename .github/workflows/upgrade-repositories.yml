name: "Upgrade Provider Repositories"

on:
  workflow_dispatch: {}
  workflow_call: {}

jobs:
  build-provider-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - id: set-matrix
        run: |
          provider=$(jq -rcM "{ provider: keys }" provider.json)
          echo "::set-output name=matrix::$provider"

  upgrade-provider:
    needs: build-provider-matrix
    name: "Upgrade"
    runs-on: ubuntu-latest
    container:
      image: docker.mirror.hashicorp.services/hashicorp/jsii-terraform
    strategy:
      fail-fast: false
      matrix: ${{fromJSON(needs.build-provider-matrix.outputs.matrix)}}
      max-parallel: 10
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v2
        with:
          path: main
      - name: Checkout cdktf-provider-${{ matrix.provider }} Repository
        uses: actions/checkout@v2
        with:
          repository: cdktf/cdktf-provider-${{ matrix.provider }}
          token: ${{ secrets.GH_COMMENT_TOKEN }}
          path: provider

      - uses: actions/github-script@v4
        name: Create projen run commands file
        with:
          script: |
            require("./main/.github/lib/create-projen-files")()

      - name: Upgrade provider project
        run: |
          unset CI
          git config user.name github-team-tf-cdk
          git config user.email github-team-tf-cdk@hashicorp.com
          git checkout -b foo-bar-${{ github.run_number }}
          yarn add --dev @cdktf/provider-project@latest projen
          npx projen
          yarn install --check-files
          yarn build-provider
          npx projen
        working-directory: ./provider

      - name: Check for changes
        id: git_diff
        run: |
          git diff --exit-code || echo "::set-output name=has_changes::true"
        working-directory: ./provider

      - if: steps.git_diff.outputs.has_changes
        name: Detect breaking version changes
        id: diff_breaking
        uses: actions/github-script@v4
        with:
          script: |
            const script = require("./main/.github/lib/detect-breaking-changes")
            await script({core, exec})

      - if: steps.git_diff.outputs.has_changes && !steps.diff_breaking.outputs.has_breaking_changes
        name: Commit (non breaking) and push changes (if changed)
        run: |
          git checkout -b upgrade-provider-project-${{ github.run_number }}
          git add .
          git commit -m "chore(deps): upgrade provider project"
          git push --set-upstream origin upgrade-provider-project-${{ github.run_number }}
        working-directory: ./provider

      - if: steps.git_diff.outputs.has_changes && steps.diff_breaking.outputs.has_breaking_changes
        name: Commit (breaking) and push changes (if changed)
        run: |
          git checkout -b upgrade-provider-project-${{ github.run_number }}
          git add .
          git commit -m "chore(deps)!: upgrade provider project"
          git push --set-upstream origin upgrade-provider-project-${{ github.run_number }}
        working-directory: ./provider

      - if: steps.git_diff.outputs.has_changes
        name: "Create PR"
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GH_COMMENT_TOKEN }}
          script: |
            const {resolve} = require('path')
            const scriptPath = resolve("./main/.github/lib/create-pr")
            await script({
              github,
              runNumber: "${{github.run_number}}",
              providerName: "${{matrix.provider}}"
            })

      - name: Send failures to Slack
        if: ${{ failure() && !cancelled() }}
        uses: slackapi/slack-github-action@v1.21.0
        with:
          payload: |
            {
              "provider_name": "${{ matrix.provider }}",
              "run_url": "https://github.com/hashicorp/cdktf-repository-manager/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.FAILURE_SLACK_WEBHOOK_URL }}
