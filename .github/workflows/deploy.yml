name: "Deploy"

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
      - name: Run standard-version
        run: npm run release
      - name: Push up git tags
        run: git push --follow-tags origin main
      - name: Publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: gh release create $(git describe --tags) -R $GITHUB_REPOSITORY -F CHANGELOG.md

  build-shard-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
      - id: set-matrix
        run: |
          stack=$(jq -rcM ".stacks | { stack: keys }" sharded-stacks.json)
          echo "matrix=$stack" >> $GITHUB_OUTPUT

  deploy:
    uses: ./.github/workflows/deploy-cdktf-stacks.yml
    needs: build-shard-matrix
    with:
      stacks: ${{ needs.build-shard-matrix.outputs.matrix }}
      upgrade-repositories: true
    secrets: inherit

  deploy_constructs:
    uses: ./.github/workflows/deploy-cdktf-stacks.yml
    with:
      stacks: '{"stack":["custom-constructs"]}'
      upgrade-repositories: false
    secrets: inherit
